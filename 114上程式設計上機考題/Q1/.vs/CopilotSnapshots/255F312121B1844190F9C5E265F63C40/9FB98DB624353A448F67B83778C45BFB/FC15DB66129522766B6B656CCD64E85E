using System;
using System.Drawing;
using System.IO;
using System.Windows.Forms;

namespace Q1
{
    public partial class Form1 : Form
    {
        // 玩家與電腦的勝場計數
        private int playerScore = 0;
        private int computerScore = 0;

        // 用於產生電腦隨機出拳
        private Random rng = new Random();

        // 儲存電腦當前的選擇（Rock/Paper/Scissors）
        private Move currentComputerChoice;

        // 備援的圖片資料夾（使用者提供的路徑）
        // 若專案內有 Images 資料夾，程式會先嘗試從專案資料夾載入；若找不到再到此路徑尋找
        private readonly string imagesFolder = @"C:\Users\m303\Downloads\114_1_C_Sharp_Tutorial-main\Images\Rock Paper Scissors";

        // cached images (may be null if not found)
        private Image rockImage;
        private Image paperImage;
        private Image scissorsImage;

        public Form1()
        {
            InitializeComponent();
            // 確保一開始圖片區域為空白，符合需求
            playerPictureBox.Image = null;
            computerPictureBox.Image = null;

            // 顯示預設提示文字
            resultLabel.Text = "準備開始...";

            // 更新分數顯示標籤
            UpdateScores();
        }

        /// <summary>
        /// 表單載入時的初始化
        /// - 清空畫面上的圖片
        /// - 初始化結果文字與分數顯示
        /// </summary>
        private void Form1_Load(object sender, EventArgs e)
        {
            // 嘗試從使用者提供的資料夾載入圖片（路徑：imagesFolder）
            try
            {
                if (Directory.Exists(imagesFolder))
                {
                    var files = Directory.GetFiles(imagesFolder);
                    foreach (var f in files)
                    {
                        string n = Path.GetFileNameWithoutExtension(f).ToLowerInvariant();
                        if (n.Contains("rock") || n.Contains("stone"))
                        {
                            if (rockImage == null) rockImage = Image.FromFile(f);
                        }
                        else if (n.Contains("paper") || n.Contains("布"))
                        {
                            if (paperImage == null) paperImage = Image.FromFile(f);
                        }
                        else if (n.Contains("scissor") || n.Contains("剪"))
                        {
                            if (scissorsImage == null) scissorsImage = Image.FromFile(f);
                        }
                    }
                }
            }
            catch
            {
                // 忽略載入錯誤，使用備援圖示
            }
        }

        /// <summary>
        /// 玩家按下「石頭」按鈕的事件處理器
        /// 直接啟動一回合遊戲流程，傳入玩家的出拳
        /// </summary>
        private void stoneButton_Click(object sender, EventArgs e)
        {
            PlayRound(Move.Rock);
        }

        /// <summary>
        /// 玩家按下「布」按鈕的事件處理器
        /// </summary>
        private void paperButton_Click(object sender, EventArgs e)
        {
            PlayRound(Move.Paper);
        }

        /// <summary>
        /// 玩家按下「剪刀」按鈕的事件處理器
        /// </summary>
        private void scissorsButton_Click(object sender, EventArgs e)
        {
            PlayRound(Move.Scissors);
        }

        /// <summary>
        /// 結束遊戲按鈕事件
        /// 顯示統計結果對話框，使用者按確定則關閉程式
        /// </summary>
        private void endGameButton_Click(object sender, EventArgs e)
        {
            string message = $"遊戲統計:\n玩家勝場: {playerScore}\n電腦勝場: {computerScore}\n\n按確定關閉程式。";
            var dr = MessageBox.Show(message, "統計結果", MessageBoxButtons.OKCancel, MessageBoxIcon.Information);
            if (dr == DialogResult.OK)
            {
                // 使用 Application.Exit 以確保應用程式完全關閉
                Application.Exit();
            }
        }

        /// <summary>
        /// 重置按鈕事件
        /// 將雙方勝場歸零，並清空圖片與結果顯示
        /// </summary>
        private void resetButton_Click(object sender, EventArgs e)
        {
            playerScore = 0;
            computerScore = 0;
            resultLabel.Text = "已重置，開始新遊戲";
            playerPictureBox.Image = null;
            computerPictureBox.Image = null;
            UpdateScores();
        }

        // 定義三種出拳列舉，方便程式邏輯判斷
        private enum Move { Rock, Paper, Scissors }

        /// <summary>
        /// 主回合流程：
        /// 1. 產生電腦出拳
        /// 2. 顯示玩家與電腦的圖片（優先使用專案內的圖片檔）
        /// 3. 判斷勝負並更新分數與結果顯示
        /// </summary>
        private void PlayRound(Move playerMove)
        {
            // 產生電腦出拳（模組化）
            getCompChoice();

            // 顯示玩家與電腦的圖片，會依序嘗試專案 Images、Resources、使用者提供之 imagesFolder、最後以動態繪製備援
            showPlayerImage(playerMove);
            showComputerImage(currentComputerChoice);

            // 判斷輸贏並更新分數與結果顯示
            showWinner(playerMove, currentComputerChoice);

            // 更新分數標籤
            UpdateScores();
        }

        /// <summary>
        /// 產生電腦選擇並儲存在 currentComputerChoice
        /// 使用 Random 類別，以確保每次均為隨機
        /// </summary>
        private void getCompChoice()
        {
            currentComputerChoice = (Move)rng.Next(0, 3); // 0..2
        }

        /// <summary>
        /// 顯示電腦的圖片
        /// 載入優先順序：專案 Images 資料夾 -> Resources 資源 -> 使用者指定外部資料夾 -> 動態備援圖
        /// </summary>
        private void showComputerImage(Move m)
        {
            string key = GetMoveKey(m);
            Image img = TryLoadProjectImage(key, "computer")
                        ?? TryLoadResourceImage($"comp_{key}")
                        ?? TryLoadImageFromFolder($"comp_{key}")
                        ?? TryLoadImageFromFolder(key);
            computerPictureBox.Image = img ?? GetImageForMove(m);
        }

        /// <summary>
        /// 顯示玩家的圖片，載入邏輯同上
        /// </summary>
        private void showPlayerImage(Move m)
        {
            string key = GetMoveKey(m);
            Image img = TryLoadProjectImage(key, "player")
                        ?? TryLoadResourceImage($"player_{key}")
                        ?? TryLoadImageFromFolder($"player_{key}")
                        ?? TryLoadImageFromFolder(key);
            playerPictureBox.Image = img ?? GetImageForMove(m);
        }

        /// <summary>
        /// 嘗試從專案內的 Images 資料夾載入檔案（相對於執行目錄）
        /// 範例檔名：stone_player.png, paper_computer.png, scissor_player.png
        /// 如果檔案存在，建立 Bitmap 複本並回傳，避免鎖定原始檔案
        /// </summary>
        private Image TryLoadProjectImage(string key, string side)
        {
            try
            {
                // 將 code-key (rock/paper/scissors) 對應到檔名命名 (stone/paper/scissor)
                string mapped = MapKeyToFilename(key); // rock->stone, scissors->scissor
                string fileName = $"{mapped}_{side}.png"; // e.g. stone_player.png

                // AppDomain.CurrentDomain.BaseDirectory 為應用程式執行目錄
                string baseDir = AppDomain.CurrentDomain.BaseDirectory;
                string imagesDir = Path.Combine(baseDir, "Images");
                string full = Path.Combine(imagesDir, fileName);

                if (File.Exists(full))
                {
                    using (var tmp = Image.FromFile(full))
                    {
                        return new Bitmap(tmp); // 回傳複本
                    }
                }
            }
            catch
            {
                // 任何例外皆忽略並回傳 null 以便使用備援流程
            }
            return null;
        }

        /// <summary>
        /// 對應檔名規則：程式內用 rock, paper, scissors；檔案採 stone, paper, scissor。
        /// 此處負責對應名稱以便載入檔案。
        /// </summary>
        private string MapKeyToFilename(string key)
        {
            return key == "rock" ? "stone" : key == "scissors" ? "scissor" : key; // paper 保持不變
        }

        /// <summary>
        /// 判斷並顯示本回合勝負
        /// - 使用 DetermineWinner 取得結果
        /// - 若玩家勝則 playerScore++，若電腦勝則 computerScore++，平手不增加
        /// - 更新 resultLabel 顯示中文結果
        /// </summary>
        private void showWinner(Move playerMove, Move computerMove)
        {
            string compStr = GetMoveName(computerMove);
            string playerStr = GetMoveName(playerMove);

            int result = DetermineWinner(playerMove, computerMove);
            if (result == 1)
            {
                playerScore++;
                resultLabel.Text = $"你出 {playerStr}，電腦出 {compStr}。你贏了！";
            }
            else if (result == -1)
            {
                computerScore++;
                resultLabel.Text = $"你出 {playerStr}，電腦出 {compStr}。你輸了。";
            }
            else
            {
                resultLabel.Text = $"你出 {playerStr}，電腦出 {compStr}。平手。";
            }
        }

        /// <summary>
        /// 將列舉 Move 轉為繁體中文顯示名稱
        /// </summary>
        private string GetMoveName(Move m)
        {
            return m == Move.Rock ? "石頭" : m == Move.Paper ? "布" : "剪刀";
        }

        /// <summary>
        /// 將列舉 Move 轉為 key（rock/paper/scissors）以供檔名對照使用
        /// </summary>
        private string GetMoveKey(Move m)
        {
            return m == Move.Rock ? "rock" : m == Move.Paper ? "paper" : "scissors";
        }

        /// <summary>
        /// 嘗試從專案的 Resources（Properties.Resources）中載入圖片
        /// 使用反射方式存取，避免在沒有該資源時產生編譯問題
        /// </summary>
        private Image TryLoadResourceImage(string resourceName)
        {
            try
            {
                var resourcesType = Type.GetType("Q1.Properties.Resources, Q1");
                if (resourcesType != null)
                {
                    var prop = resourcesType.GetProperty(resourceName, System.Reflection.BindingFlags.Static | System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic);
                    if (prop != null)
                    {
                        var val = prop.GetValue(null);
                        return val as Image;
                    }
                }
            }
            catch
            {
                // 若反射或取得資源失敗，忽略並回傳 null
            }
            return null;
        }

        /// <summary>
        /// 嘗試從使用者指定之外部資料夾載入圖片（此資料夾由 imagesFolder 指定）
        /// 支援常見副檔名 (.png, .jpg, .jpeg, .bmp, .gif)
        /// 回傳 Bitmap 的複本避免鎖定原始檔案
        /// </summary>
        private Image TryLoadImageFromFolder(string baseName)
        {
            try
            {
                if (string.IsNullOrEmpty(imagesFolder)) return null;
                string[] exts = new[] { ".png", ".jpg", ".jpeg", ".bmp", ".gif" };
                foreach (var ext in exts)
                {
                    string f = Path.Combine(imagesFolder, baseName + ext);
                    if (File.Exists(f))
                    {
                        // FromFile 會鎖定檔案，因此用 using 開啟後回傳複本
                        using (var tmp = Image.FromFile(f))
                        {
                            return new Bitmap(tmp);
                        }
                    }
                }
            }
            catch
            {
                // 若載入失敗，忽略並回傳 null
            }
            return null;
        }

        /// <summary>
        /// 判斷勝負邏輯：
        /// 回傳 1 表示玩家勝，-1 表示電腦勝，0 表示平手
        /// 此方法實作標準猜拳規則：石頭>剪刀、剪刀>布、布>石頭
        /// </summary>
        private int DetermineWinner(Move p, Move c)
        {
            if (p == c) return 0;
            if ((p == Move.Rock && c == Move.Scissors) ||
                (p == Move.Paper && c == Move.Rock) ||
                (p == Move.Scissors && c == Move.Paper))
                return 1;
            return -1;
        }

        /// <summary>
        /// 更新分數顯示標籤（將最新勝場數顯示於 UI）
        /// </summary>
        private void UpdateScores()
        {
            playerScoreLabel.Text = $"玩家勝場: {playerScore}";
            computerScoreLabel.Text = $"電腦勝場: {computerScore}";
        }

        /// <summary>
        /// 當找不到圖片資源時的備援：以程式繪製簡單圖示
        /// - 使用圓形與中文字顯示代表
        /// - 此函式回傳一個 Bitmap，可直接設定給 PictureBox.Image
        /// </summary>
        private Bitmap GetImageForMove(Move m)
        {
            Image img = m == Move.Rock ? rockImage : m == Move.Paper ? paperImage : scissorsImage;
            if (img != null) return img;

            // fallback to dynamically drawn image
            int w = playerPictureBox.Width;
            int h = playerPictureBox.Height;
            var bmp = new Bitmap(w, h);
            using (var g = Graphics.FromImage(bmp))
            {
                g.Clear(Color.White);
                // 根據出拳不同填色
                Color circleColor = m == Move.Rock ? Color.LightGray : m == Move.Paper ? Color.LightBlue : Color.LightPink;
                using (var brush = new SolidBrush(circleColor))
                {
                    g.FillEllipse(brush, 10, 10, Math.Min(w, h) - 20, Math.Min(w, h) - 20);
                }

                // 在圓中央畫上中文單字（石/布/剪）作為代表
                string txt = m == Move.Rock ? "石" : m == Move.Paper ? "布" : "剪";
                using (var sf = new StringFormat() { Alignment = StringAlignment.Center, LineAlignment = StringAlignment.Center })
                using (var font = new Font("Segoe UI", Math.Max(24, Math.Min(w, h) / 3), FontStyle.Bold, GraphicsUnit.Point))
                using (var brush = new SolidBrush(Color.Black))
                {
                    Rectangle rect = new Rectangle(0, 0, w, h);
                    g.DrawString(txt, font, brush, rect, sf);
                }
            }
            return bmp;
        }

        // 目前沒有特殊行為，只保留空的 Click 事件處理器以避免 Designer 參考遺失
        private void computerPictureBox_Click(object sender, EventArgs e)
        {

        }
    }
}
