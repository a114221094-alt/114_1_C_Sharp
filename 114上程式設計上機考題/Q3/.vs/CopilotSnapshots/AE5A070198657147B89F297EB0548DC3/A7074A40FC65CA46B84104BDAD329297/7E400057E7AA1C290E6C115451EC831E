using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace Q3
{
    public partial class Form1 : Form
    {
        private List<int> generatedNumbers = new List<int>();
        private List<int> drawNumbers = new List<int>();

        public Form1()
        {
            InitializeComponent();
        }

        private void btnGenerate_Click(object sender, EventArgs e)
        {
            generatedNumbers = GenerateNumbers(6, 1, 49);
            lstGenerated.Items.Clear();
            foreach (var n in generatedNumbers)
                lstGenerated.Items.Add(n);

            lstMatches.Items.Clear();
        }

        private void btnLoadDraw_Click(object sender, EventArgs e)
        {
            if (openFileDialog1.ShowDialog() != DialogResult.OK)
                return;

            try
            {
                var lines = File.ReadAllLines(openFileDialog1.FileName);
                // Expect numbers separated by spaces or commas on first non-empty line
                var nums = new List<int>();
                foreach (var line in lines)
                {
                    if (string.IsNullOrWhiteSpace(line))
                        continue;
                    var parts = line.Split(new[] { ' ', ',', '\t' }, StringSplitOptions.RemoveEmptyEntries);
                    foreach (var p in parts)
                    {
                        if (int.TryParse(p, out int v))
                            nums.Add(v);
                    }
                    if (nums.Count > 0)
                        break; // only first non-empty line
                }

                drawNumbers = nums.Distinct().OrderBy(x => x).ToList();

                lstDraw.Items.Clear();
                foreach (var n in drawNumbers)
                    lstDraw.Items.Add(n);

                MessageBox.Show("開獎號碼讀取完成", "資訊", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show("讀取檔案失敗: " + ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnCompare_Click(object sender, EventArgs e)
        {
            lstMatches.Items.Clear();
            if (generatedNumbers == null || generatedNumbers.Count == 0)
            {
                MessageBox.Show("請先產生號碼", "提醒", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (drawNumbers == null || drawNumbers.Count == 0)
            {
                MessageBox.Show("請先讀取開獎號碼檔案", "提醒", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var matches = generatedNumbers.Intersect(drawNumbers).OrderBy(x => x).ToList();
            foreach (var m in matches)
                lstMatches.Items.Add(m);

            MessageBox.Show($"比對完成，共中 {matches.Count} 個號碼", "結果", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        private List<int> GenerateNumbers(int count, int min, int max)
        {
            var rnd = new Random();
            var set = new HashSet<int>();
            while (set.Count < count)
            {
                set.Add(rnd.Next(min, max + 1));
            }
            return set.OrderBy(x => x).ToList();
        }
    }
}
